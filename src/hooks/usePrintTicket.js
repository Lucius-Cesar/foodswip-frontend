import { useState, useEffect, useRef } from "react";
import html2canvas from "html2canvas";

// the usePrintTicket hook generate a ticketSrc from the ticketRef (linked to OrderTicket Component)
// the aim is to inject jpg base 64 in an href beginning with rawbt:
// <a href={`rawbt:base64,${ticketSrc}`} is inside OrderDetails component to allow interactity with button
const usePrintTicket = () => {
  //
  const isAndroidDevice = true;
  const [loading, setLoading] = useState(isAndroidDevice ? true : false);

  const ticketRef = useRef(null);
  const [ticketSrc, setTicketSrc] = useState(null);

  const generateTicketBase64 = async () => {
    const canvas = await html2canvas(ticketRef.current);
    const dataUrl = canvas.toDataURL();
    const regexp = /base64,[A-Za-z0-9+/=]+/;
    const ticketBase64 = dataUrl.match(regexp);
    return ticketBase64;
  };

  useEffect(() => {
    if (!ticketRef.current) return;
    const getTicketSrc = async () => {
      const newTicketSrc = await generateTicketBase64();
      setTicketSrc(
        "base64,G0AddjAAEACUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//AAAAAAAAAAAAAAAAAAH//8AAAAAAAAAAAAAAAAAP///wAAAAAAAAAAAAAAAAH////AAAAAAAAAAAAAAAAH////4AAAAAAAAAAAAAAAD/////AAAAAAAAAAAAAAAB/////4AAAAAAAAAAAAAAAf/////AAAAAAAAAAAAAAAP/////wAAAAAAAAAAAAAAH/////+AAAAAAAAAAAAAAB//////gAAAAAAAAAAAAAA//////8AAAAAAAAAAAAAAP//////AAAAAAAAAAAAAAD//////wAAAAAAAAAAAAAB//////+AAAAAAAAAAAAAAf//////gAAAAAAAAAAAAAH//////4AAAAAAAAAAAAAB//////+AAAAAAAAAAAAAAf//////wAAAAAAAAAAAAAH//////8AAAAAAAAAAAAAB///4H//AAAAAAAAAAAAAA/j/8A//wAAAAAAAAAAAAAPwf+AH/8AAAAAAAAAAAAAD4D/AA//AAAAAAAAAAAAAA8AfwAP/wAAAAAAAAAAAAAPAH8EB/8AAAAAAAAAAAAADwB+Dwf/AAAAAAAAAAAAAA4cPh8H/4AAAAAAAAAAAAAOPD4fh/+AAAAAAAAAAAAABj4+P4f/gAAAAAAAAAAAAAc+Pj+H/4AAAAAAAAAAAAAHPuP/h/+AAAAAAAAAAAAABz8Af4f/gAAAAAAAAAAAAAceAB8H/4AAAAAAAAAAAAAHnAAHD/+AAAAAAAAAAAAAB9AAAf//gAAAAAAAAAAAAAfgAAA//4AAAAAAAAAAAAAHwAAAD/+AAAAAAAAAAAAAB4AAAAf/gAAAAAAAAAAAAAcAAAAH/4AAAAAAAAAAAAAGQAAAx/+AAAAAAAAAAAAABmAAA4f/gAAAAAAAAAAAAA8wAAYH/4AAAAAAAAAAAAAPGAAYD/+AAAAAAAAAAAAAD4YAcBv/wAAAAAAAAAAAAA/Dg8Az/8AAAAAAAAAAAAAP8H4Aw//gAAAAAAAAAAAAH5gABwH/4AAAAAAAAAAAAB+EAAwB//AAAAAAAAAAAAA/gwAwAf/wAAAAAAAAAAAAP4GA4AH/+AAAAAAAAAAAAD+AfwAA//wAAAAAAAAAAAB/AAAAAP/8AAAAAAAAAAAA/wAAAAB//gAAAAAAAAAAAP8AAAAAf/8AAAAAAAAAAAH+AAAAAH//gAAAAAAAAAAD/gAAAAA//4AAAAAAAAAAA/4AAAAAP//AAAAAAAAAAAf8AAAAAD//4AAAAAAAAAAP/AAAAAAf//AAAAAAAAAAH/wAAAAAH//4AAAAAAAAAB/4AAAAAA//+AAAAAAAAAA/+AAAAAAP//wAAAAAAAAAf/gAAAAAD//+AAAAAAAAAP/wAAAAAAff/wAAAAAAAAD/8AAAAAAH7/8AAAAAAAAB/+AAAAAAA/f/gAAAAAAAA//gAAAAAAP7/8AAAAAAAAP3wAAAAAAB/f/AAAAAAAAH78AAAAAAAf3/4AAAAAAAD+/AAAAAAAD+/+AAAAAAAA/fgAAAAAAA/3/wAAAAAAAf34AAAAAAAH9/8AAAAAAAH78AAAAAAAB/v/gAAAAAAD+/AAAAAAAAP7/4AAAAAAA/fgAAAAAAAD+f/AAAAAAAf34AAAAAAAAf3/wAAAAAAH58AAAAAAAAH8/+AAAAAAD+/AAAAAAAAA/P/gAAAAAA/vwAAAAAAAAP7/8AAAAAAfz4AAAAAAAAD+//AAAAAAH8+AAAAAAAAAfn/wAAAAAB/fAAAAAAAAAH5/8AAAAAA/3wAAAAAAAAB+f/gAAAAAP58AAAAAAAAAPn/4AAAAAD+fAAAAAAAAAD5/+AAAAAB/ngAAAAAAAAA+f/gAAAAAf54AAAAAAAAAPH/4AAAAAH+eAAAAAAAAABx//AAAAAB/jgAAAAAAAAAAf/wAAAAA/44AAAAAAAAAAH/8AAAAAP+OAAAAAAAAABgf/AAAAAD/zAAAAAAAAAD/D/wAAAAA/8QAAAAAAAAAw+P8AAAAAP/AAAAAAAAAAYD5/AAAAAD/4AAAAAAAAAEAPPgAAAAA//AAAAAAAAADAB54AAAAAP/wAAAAAAAABwAPeAAAAAD/+AAAAAAAAA8AD3gAAAAA4PwAAAAAAAAZAA94AAAAAcB+AAAAAAAAMYAf8AAAAAOAH4AAAAAAADGAP/gAAAAHAA/AAAAAAABgwH4eAAAABgAP8AAAAAAAYOH8BwAAAAwAB/gAAAAAAGB/8AMAAAAcAAP+AAAAAADAP+ABgAAA+AAD/wAAAAAAwB+AAYAAA+AAAf+AAAAAAMAAAAGAAA+AAAH/wAAAAADAAAAAwAAcAAAA/+AAAAAAwAAAAMAAOAAAAP/gAAAAAMAAAADAADAAAAB/8AAAAADAAAAAwABgAAAAf/gAAAAAgAAAAGAAYAAAAD/4AAAAAIAAAABgAGAAAAA//AAAAAGAAAAAcABgAAAAH/wAAAABgAAAADgAYAAAAA/8AAAAAYAAAAAYAGAAAAAP/AAAAAGAAAAADABgAAAAB/gAAAABgAAAAA4AYAAAAAPwAAAAAYAAAAAGADAAAAABwAAAAAMAAAAAAwAwAAAAAcAAAAADAAAAAAMAMAAAAADgAAAAAwAAAAADADAAAAAAYAAAAAMAAAAAAwBgAAAAADAAAAAOAAAAAAYAYAAAAAAYAAAAHgAAAAAOAGAAAAAAHAAAAH4AAAAAPADAAAAAAA8AAAH8AAAAAHgAwAAAAAAPwAAH/AAAAAHgAMAAAAAAB/gAf/wAAAAHgADAAAAAAAf////8AAAAHgAAwAAAAAAH/////AAAAHgAAGAAAAAAA/////wAAADgAABwAAAAAAP////4AAADwAAAPgAAAAAH////+AAABwAAAA/8AAAAB//A//wAAA4AAAAB//AAAAfwAABcAAAcAAAAAAH+AAAMAAAADAAAOAAAAAAAD4AAHAAAAAYAAHAAAAAAAAPgADgAAAAGAADgAAAAAAAA/ADwAAAAAwABwAAAAAAAAB//4AAAAAHAB4AAAAAAAAAD/wAAAAAA8D4AAAAAAAAAAAAAAAAAAH/4AAAAAAAAAAAAAAAAAAAPwAAAAAAAAAAAAAAAAAAAAAAAAAAAK"
      );
    };

    // only generate ticketSrc on android device, rawbt does not work with IOS
    if (isAndroidDevice) {
      setLoading(true);
      getTicketSrc();
      setLoading(false);
    }
  }, [ticketRef.current]);

  return { ticketRef, ticketSrc, isAndroidDevice, loading, setLoading };
};

export default usePrintTicket;
